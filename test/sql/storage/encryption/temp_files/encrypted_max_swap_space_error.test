# name: test/sql/storage/encryption/temp_files/encrypted_max_swap_space_error.test
# description: Test the maximum swap space.
# group: [temp_files]

require noforcestorage

require skip_reload

# This test performs comparisons against the DEFAULT_BLOCK_ALLOC_SIZE of 256KiB.
require block_size 262144

# The temporary directory usage changes with the vector size.
require vector_size 2048

# Set a temp_directory to offload data
statement ok
set temp_directory='__TEST_DIR__/max_swap_space_reached'

# Ensure the temp_directory is used
statement ok
PRAGMA memory_limit='1024KiB'

# Zero blocks
statement ok
set max_temp_directory_size='0KiB'

statement ok
ATTACH '__TEST_DIR__/encrypted_tmp.db' as enc (ENCRYPTION_KEY 'asdf');

statement ok
USE enc;

statement error
CREATE OR REPLACE TABLE t2 AS SELECT random() FROM range(1000000);
----
failed to offload data block

query I
select "size" from duckdb_temporary_files()
----
0

# Max. one block for the default block allocation size
statement ok
set max_temp_directory_size='256KiB'

statement error
CREATE OR REPLACE TABLE t2 AS SELECT random() FROM range(1000000);
----
failed to offload data block

statement error
CREATE OR REPLACE TABLE t2 AS SELECT random() FROM range(1000000);
----
failed to offload data block

query I
select "size" from duckdb_temporary_files()
----

statement ok
set max_temp_directory_size='4MB'

statement ok
pragma threads=2;

statement ok
set preserve_insertion_order=true;

# Ensure the temp_directory is used
statement ok
PRAGMA memory_limit='1624KiB'

statement ok
CREATE OR REPLACE TABLE t2 AS SELECT random() FROM range(200000);

statement error
CREATE OR REPLACE TABLE t2 AS SELECT * FROM range(10000000);
----
failed to offload data block

query I
select current_setting('max_temp_directory_size')
----
3.8 MiB

statement ok
set max_temp_directory_size='2550KiB'

query I
select current_setting('max_temp_directory_size')
----
2.4 MiB